<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual de PDF</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        canvas { border: 1px solid black; cursor: crosshair; margin-top: 10px; }
        #downloadLink { display: none; margin-top: 10px; }
        button { margin: 5px; padding: 10px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
</head>
<body>
    <h2>Editor Visual de PDF</h2>
    <input type="file" id="pdfInput">
    <br><br>
    <canvas id="pdfCanvas"></canvas>
    <br>
    <input type="text" id="textToAdd" placeholder="Escribe algo...">
    <button id="undoBtn">‚è™ Deshacer</button>
    <button id="redoBtn">‚è© Rehacer</button>
    <button id="clearBtn">üóë Borrar Todo</button>
    <button id="downloadBtn">üì• Descargar PDF</button>
    <a id="downloadLink">Descargar</a>

    <script>
        let pdfDoc = null, pdfBytes = null, pdfLibDoc = null;
        let currentPage = null;
        let textEntries = []; // Lista de textos agregados
        let undoStack = []; // Para deshacer cambios
        let redoStack = []; // Para rehacer cambios
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        document.getElementById('pdfInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const typedArray = new Uint8Array(e.target.result);
                pdfDoc = await pdfjsLib.getDocument({ data: typedArray }).promise;
                currentPage = await pdfDoc.getPage(1);
                pdfLibDoc = await PDFLib.PDFDocument.load(typedArray);

                textEntries = [];
                undoStack = [];
                redoStack = [];
                renderPDF();
            };
            reader.readAsArrayBuffer(file);
        });

        async function renderPDF() {
            const viewport = currentPage.getViewport({ scale: 1.5 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const renderContext = { canvasContext: ctx, viewport: viewport };
            await currentPage.render(renderContext).promise();

            // Redibujar los textos agregados
            ctx.fillStyle = "red";
            ctx.font = "16px Arial";
            textEntries.forEach(entry => {
                ctx.fillText(entry.text, entry.x, entry.y);
            });
        }

        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const text = document.getElementById('textToAdd').value;

            if (text) {
                undoStack.push([...textEntries]); // Guardamos el estado para deshacer
                redoStack = []; // Limpiamos el redoStack al agregar nuevo texto
                textEntries.push({ text, x, y });
                renderPDF();
            }
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (undoStack.length > 0) {
                redoStack.push([...textEntries]); // Guardamos para rehacer
                textEntries = undoStack.pop(); // Restauramos el estado anterior
                renderPDF();
            }
        });

        document.getElementById('redoBtn').addEventListener('click', () => {
            if (redoStack.length > 0) {
                undoStack.push([...textEntries]); // Guardamos el estado para deshacer
                textEntries = redoStack.pop(); // Restauramos el estado siguiente
                renderPDF();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            undoStack.push([...textEntries]); // Guardamos estado antes de borrar
            redoStack = []; // Limpiamos el redoStack
            textEntries = []; // Vaciamos la lista de textos
            renderPDF();
        });

        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!pdfLibDoc) {
                alert('Sube un PDF primero.');
                return;
            }

            const page = pdfLibDoc.getPages()[0];

            textEntries.forEach(entry => {
                page.drawText(entry.text, { x: entry.x, y: canvas.height - entry.y, size: 16 });
            });

            const editedPdfBytes = await pdfLibDoc.save();
            const blob = new Blob([editedPdfBytes], { type: 'application/pdf' });
            const link = document.getElementById('downloadLink');
            link.href = URL.createObjectURL(blob);
            link.download = 'editado.pdf';
            link.style.display = 'block';
            link.innerText = 'Descargar PDF Editado';
        });
    </script>
</body>
</html>
